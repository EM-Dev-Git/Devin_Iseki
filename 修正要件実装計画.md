# 生産受払システム機能追加 - 実装計画

## 1. 修正概要

井関物流の生産受払システムに以下の機能を追加します：

1. **自動計算機能**: 単価、数量入力後、金額が自動計算される機能
2. **入力促進機能**: 単価、数量いずれか未入力の場合、入力を促す背景反転色付け
3. **手入力防止**: 金額は手入力ができないようグレーアウト化
4. **単位項目追加**: 請求書記載の数量の単位について、「単位」単独の項目を追加
5. **必須項目化**: 追加項目の単位は入力必須項目とし、未入力の場合背景色付けエラー表示
6. **請求書フォーマット修正**: 金額と単位の間に線を入れる

## 2. 修正対象ファイル

1. **RegisterSeikyuMasterForm.vb**
   - `UcDgv_CellEndEdit`メソッド: 自動計算ロジック追加
   - `changeGridview`メソッド: KINGAKU読み取り専用設定
   - `AddRow_Button_Click`メソッド: 新規行追加時の初期設定

2. **OutputSeikyuReportS.rdlc**
   - 数量と単位の表示形式変更
   - 金額と単位の間に線を追加

## 3. 実装詳細

### 3.1 RegisterSeikyuMasterForm.vb の修正

#### 3.1.1 `UcDgv_CellEndEdit`メソッドの修正

```vb
Private Sub UcDgv_CellEndEdit(sender As Object, e As DataGridViewCellEventArgs) Handles UcDgv.DgvCellEndEdit
    Dim customDataGridView As CustomDataGridView = CType(sender, CustomDataGridView)
    Dim dataGridViewColumn As DataGridViewColumn = customDataGridView.Columns(e.ColumnIndex)
    Dim dataGridViewRow As DataGridViewRow = customDataGridView.Rows(e.RowIndex)
    
    ' 値が変更されていない場合は処理しない
    If Operators.ConditionalCompareObjectEqual(customDataGridView.CellValuePre, dataGridViewRow.Cells(e.ColumnIndex).Value, False) Then
        Return
    End If
    
    ' 既存の検証処理（SAKI_CD, KAZEI_KBN, MEISAI_UMU）
    ' [既存コードは省略]
    
    ' ===== 追加: 自動計算機能 =====
    ' SURYO（数量）またはTANKA（単価）が変更された場合、KINGAKU（金額）を自動計算
    If "SURYO".Equals(dataGridViewColumn.Name) OrElse "TANKA".Equals(dataGridViewColumn.Name) Then
        ' エラー表示をクリア
        dataGridViewRow.Cells("SURYO").ErrorText = Nothing
        dataGridViewRow.Cells("TANKA").ErrorText = Nothing
        dataGridViewRow.Cells("TANI").ErrorText = Nothing
        
        ' 数量と単価の値を取得
        Dim suryo As Decimal = 0
        Dim tanka As Decimal = 0
        Dim hasValue As Boolean = True
        
        ' 数量の検証
        If IsNothing(dataGridViewRow.Cells("SURYO").Value) OrElse 
           String.IsNullOrEmpty(Conversions.ToString(dataGridViewRow.Cells("SURYO").Value)) Then
            dataGridViewRow.Cells("SURYO").Style.BackColor = Color.MistyRose
            hasValue = False
        Else
            Decimal.TryParse(Conversions.ToString(dataGridViewRow.Cells("SURYO").Value), suryo)
            dataGridViewRow.Cells("SURYO").Style.BackColor = Me._bkcolor_normal
        End If
        
        ' 単価の検証
        If IsNothing(dataGridViewRow.Cells("TANKA").Value) OrElse 
           String.IsNullOrEmpty(Conversions.ToString(dataGridViewRow.Cells("TANKA").Value)) Then
            dataGridViewRow.Cells("TANKA").Style.BackColor = Color.MistyRose
            hasValue = False
        Else
            Decimal.TryParse(Conversions.ToString(dataGridViewRow.Cells("TANKA").Value), tanka)
            dataGridViewRow.Cells("TANKA").Style.BackColor = Me._bkcolor_normal
        End If
        
        ' 単位の検証
        If IsNothing(dataGridViewRow.Cells("TANI").Value) OrElse 
           String.IsNullOrEmpty(Conversions.ToString(dataGridViewRow.Cells("TANI").Value)) Then
            dataGridViewRow.Cells("TANI").Style.BackColor = Color.MistyRose
        Else
            dataGridViewRow.Cells("TANI").Style.BackColor = Me._bkcolor_normal
        End If
        
        ' 数量と単価の両方が入力されている場合、金額を計算
        If hasValue Then
            ' 取引先情報から端数処理方法を取得
            Dim hasuKbn As String = "1" ' デフォルト値
            Using sqlDataBase As New SqlDataBase(Me._conf.xmlConfData.xDataBase)
                Dim sql As String = "SELECT HASU_KBN FROM Ukeharai.M_TORI WHERE TORI_CD = '" & Me.ComboTori1.Text.Trim() & "'"
                If sqlDataBase.execSql(sql) Then
                    If sqlDataBase.DbData.DataList.Count > 0 Then
                        hasuKbn = Conversions.ToString(sqlDataBase.DbData.DataList(0)("HASU_KBN"))
                    End If
                End If
            End Using
            
            ' 金額を計算（数量 × 単価）
            Dim kingaku As Decimal = suryo * tanka
            
            ' 端数処理（取引先マスタのHASU_KBNに基づく）
            kingaku = Common.hasu(kingaku, hasuKbn)
            
            ' 金額を設定
            dataGridViewRow.Cells("KINGAKU").Value = kingaku
        End If
    End If
    
    ' 単位の検証（単独で変更された場合）
    If "TANI".Equals(dataGridViewColumn.Name) Then
        dataGridViewRow.Cells("TANI").ErrorText = Nothing
        If IsNothing(dataGridViewRow.Cells("TANI").Value) OrElse 
           String.IsNullOrEmpty(Conversions.ToString(dataGridViewRow.Cells("TANI").Value)) Then
            dataGridViewRow.Cells("TANI").Style.BackColor = Color.MistyRose
        Else
            dataGridViewRow.Cells("TANI").Style.BackColor = Me._bkcolor_normal
        End If
    End If
    
    ' ===== 追加ここまで =====
    
IL_330:
    dataGridViewRow = Nothing
End Sub
```

#### 3.1.2 `changeGridview`メソッドの修正

```vb
Private Sub changeGridview()
    Try
        For Each obj As Object In CType(Me.UcDgv.CustDgv.Rows, IEnumerable)
            Dim dataGridViewRow As DataGridViewRow = CType(obj, DataGridViewRow)
            dataGridViewRow.Cells("KUBUN").[ReadOnly] = False
            dataGridViewRow.Cells("KUBUN").Style.BackColor = Me._bkcolor_normal
            dataGridViewRow.Cells("UCHIWAKE").[ReadOnly] = False
            dataGridViewRow.Cells("UCHIWAKE").Style.BackColor = Me._bkcolor_normal
            
            ' 作業区分が"1"の場合は全フィールドを読み取り専用に
            If "1".Equals(RuntimeHelpers.GetObjectValue(dataGridViewRow.Cells("SAKU_KBN").Value)) Then
                dataGridViewRow.Cells("SURYO").[ReadOnly] = True
                dataGridViewRow.Cells("SURYO").Style.BackColor = Me._bkcolor_readonly
                dataGridViewRow.Cells("TANKA").[ReadOnly] = True
                dataGridViewRow.Cells("TANKA").Style.BackColor = Me._bkcolor_readonly
                dataGridViewRow.Cells("TANI").[ReadOnly] = True
                dataGridViewRow.Cells("TANI").Style.BackColor = Me._bkcolor_readonly
                dataGridViewRow.Cells("KINGAKU").[ReadOnly] = True
                dataGridViewRow.Cells("KINGAKU").Style.BackColor = Me._bkcolor_readonly
                dataGridViewRow.Cells("KAZEI_KBN").[ReadOnly] = True
                dataGridViewRow.Cells("KAZEI_KBN").Style.BackColor = Me._bkcolor_readonly
                dataGridViewRow.Cells("MEISAI_UMU").[ReadOnly] = True
                dataGridViewRow.Cells("MEISAI_UMU").Style.BackColor = Me._bkcolor_readonly
            Else
                dataGridViewRow.Cells("SURYO").[ReadOnly] = False
                dataGridViewRow.Cells("SURYO").Style.BackColor = Me._bkcolor_normal
                dataGridViewRow.Cells("TANKA").[ReadOnly] = False
                dataGridViewRow.Cells("TANKA").Style.BackColor = Me._bkcolor_normal
                dataGridViewRow.Cells("TANI").[ReadOnly] = False
                dataGridViewRow.Cells("TANI").Style.BackColor = Me._bkcolor_normal
                
                ' ===== 修正: 金額フィールドを常に読み取り専用に =====
                dataGridViewRow.Cells("KINGAKU").[ReadOnly] = True
                dataGridViewRow.Cells("KINGAKU").Style.BackColor = Me._bkcolor_readonly
                ' ===== 修正ここまで =====
                
                dataGridViewRow.Cells("KAZEI_KBN").[ReadOnly] = False
                dataGridViewRow.Cells("KAZEI_KBN").Style.BackColor = Me._bkcolor_normal
                dataGridViewRow.Cells("MEISAI_UMU").[ReadOnly] = False
                dataGridViewRow.Cells("MEISAI_UMU").Style.BackColor = Me._bkcolor_normal
            End If
            
            dataGridViewRow.Cells("SAKI_CD").[ReadOnly] = True
            dataGridViewRow.Cells("SAKI_CD").Style.BackColor = Me._bkcolor_readonly
            dataGridViewRow.Cells("TEKIYO").[ReadOnly] = False
            dataGridViewRow.Cells("TEKIYO").Style.BackColor = Me._bkcolor_normal
        Next
    Finally
        Dim enumerator As IEnumerator = Nothing
        If TypeOf enumerator Is IDisposable Then
            TryCast(enumerator, IDisposable).Dispose()
        End If
    End Try
End Sub
```

### 3.2 OutputSeikyuReportS.rdlc の修正

RDLCファイルの修正は、Visual Studioのレポートデザイナーを使用して行うのが理想的ですが、テキストエディタでも以下の変更が必要です：

1. 数量と単位を別々のテキストボックスに分離
2. 数量と単位の間に線を追加

```xml
<!-- 数量フィールドの修正 -->
<Textbox Name="SURYO">
  <KeepTogether>true</KeepTogether>
  <Paragraphs>
    <Paragraph>
      <TextRuns>
        <TextRun>
          <Value>=Format(Fields!SURYO.Value,"#,###")</Value>
          <Style>
            <FontFamily>ＭＳ ゴシック</FontFamily>
            <Color>=IIf(Fields!SURYO.Value &lt; 0,"Red","Black")</Color>
          </Style>
        </TextRun>
      </TextRuns>
      <Style>
        <TextAlign>Right</TextAlign>
      </Style>
    </Paragraph>
  </Paragraphs>
  <rd:DefaultName>SURYO</rd:DefaultName>
  <Style>
    <Border>
      <Style>Solid</Style>
      <Width>0.5pt</Width>
    </Border>
    <TopBorder>
      <Style>None</Style>
    </TopBorder>
    <LeftBorder>
      <Style>None</Style>
    </LeftBorder>
    <RightBorder>
      <Style>Solid</Style>
      <Width>0.5pt</Width>
    </RightBorder>
    <VerticalAlign>Middle</VerticalAlign>
    <PaddingLeft>2pt</PaddingLeft>
    <PaddingRight>2pt</PaddingRight>
  </Style>
</Textbox>

<!-- 単位フィールドの追加 -->
<Textbox Name="TANI">
  <KeepTogether>true</KeepTogether>
  <Paragraphs>
    <Paragraph>
      <TextRuns>
        <TextRun>
          <Value>=Fields!TANI.Value</Value>
          <Style>
            <FontFamily>ＭＳ ゴシック</FontFamily>
          </Style>
        </TextRun>
      </TextRuns>
      <Style>
        <TextAlign>Left</TextAlign>
      </Style>
    </Paragraph>
  </Paragraphs>
  <rd:DefaultName>TANI</rd:DefaultName>
  <Style>
    <Border>
      <Style>Solid</Style>
      <Width>0.5pt</Width>
    </Border>
    <TopBorder>
      <Style>None</Style>
    </TopBorder>
    <LeftBorder>
      <Style>Solid</Style>
      <Width>0.5pt</Width>
    </LeftBorder>
    <VerticalAlign>Middle</VerticalAlign>
    <PaddingLeft>2pt</PaddingLeft>
    <PaddingRight>2pt</PaddingRight>
  </Style>
</Textbox>
```

## 4. テスト計画

### 4.1 単体テスト

1. **自動計算機能のテスト**
   - 数量に「10」、単価に「1000」を入力し、金額が「10000」と表示されることを確認
   - 数量に「0.5」、単価に「1000」を入力し、金額が「500」と表示されることを確認
   - 端数処理の違いによる計算結果の差異を確認

2. **入力促進機能のテスト**
   - 数量のみ入力し、単価が未入力の状態で背景色が変わることを確認
   - 単価のみ入力し、数量が未入力の状態で背景色が変わることを確認
   - 単位が未入力の状態で背景色が変わることを確認

3. **手入力防止のテスト**
   - 金額フィールドが常に読み取り専用であることを確認
   - 金額フィールドの背景色が常にグレーアウト色であることを確認

4. **請求書フォーマットのテスト**
   - 請求書を出力し、数量と単位の間に線が入っていることを確認
   - 数量と単位が適切に表示されていることを確認

### 4.2 結合テスト

1. **データ保存のテスト**
   - 自動計算された金額が正しくデータベースに保存されることを確認
   - 単位が正しくデータベースに保存されることを確認

2. **データ読み込みのテスト**
   - 保存したデータを再度読み込み、金額と単位が正しく表示されることを確認

3. **請求書出力のテスト**
   - 複数の明細を含む請求書を出力し、すべての明細で数量と単位の間に線が入っていることを確認

## 5. 実装スケジュール

| 作業項目 | 予定工数 | 担当者 |
|---------|---------|-------|
| 詳細設計 | 1人日 | 開発担当 |
| RegisterSeikyuMasterForm.vb の修正 | 2人日 | 開発担当 |
| OutputSeikyuReportS.rdlc の修正 | 1人日 | 開発担当 |
| 単体テスト | 1人日 | 開発担当 |
| 結合テスト | 1人日 | 開発担当 |
| ユーザーテスト | 1人日 | ユーザー |
| 合計 | 7人日 | - |

## 6. リスク評価

1. **既存データへの影響**
   - 既存の請求データに単位が設定されていない場合、表示に問題が生じる可能性がある
   - 対策：既存データの単位情報を一括で設定するスクリプトを用意する

2. **計算ロジックの複雑さ**
   - 取引先ごとに異なる端数処理方法が設定されている場合、計算結果が予期せぬ値になる可能性がある
   - 対策：複数の取引先パターンでテストを実施し、計算結果を検証する

3. **レポート修正の難易度**
   - RDLCファイルの手動編集は複雑で、予期せぬ問題が発生する可能性がある
   - 対策：Visual Studioのレポートデザイナーを使用して修正を行う

## 7. まとめ

本実装計画に基づき、生産受払システムに自動計算機能等を追加することで、以下の効果が期待できます：

1. 入力ミスによる会計処理エラーの防止
2. 入力作業の効率化
3. データの正確性向上
4. ユーザビリティの向上

実装にあたっては、既存機能への影響を最小限に抑えつつ、要件を満たす機能を提供します。
