# IbUkeharai システム - レグレッションテスト計画書

## テスト目的

本テストは、請求マスタ登録画面の機能追加（自動計算機能、入力促進機能、手入力防止機能）および請求書フォーマット修正が、システムの既存機能に悪影響を与えていないことを確認するために実施します。

## テスト環境

- Docker コンテナ: SQL Server 2017
- データベース: UkeharaiDB_Matsuyama
- スキーマ: Ukeharai
- 接続情報: localhost, sa, StrongPassword123!

## テスト対象機能

### 1. 登録機能
- 取引先マスタ登録
- 部品マスタ登録
- 単価マスタ登録
- 請求マスタ登録 ※修正対象
- 納入先マスタ登録
- 定数マスタ登録
- 受入実績登録
- 払出実績登録

### 2. データ作成機能
- 取引先受払日次データ作成
- 取引先受払月次データ作成
- 月間受払日別展開
- 部品マスタ作成
- 取引先マスタ作成
- 納入先マスタ作成

### 3. 帳票出力機能
- 請求書出力 ※修正対象
- 実績表出力
- 部品リスト
- 在庫日次・月次リスト
- 受払確認書
- 受払レポート

### 4. バッチ処理機能
- 受入データ一括処理
- 払出データ一括処理
- 月次データ処理
- 年次データ処理
- 取引先一括変更

## テスト方法

### 1. データベース整合性テスト
以下のSQLクエリを実行し、データベースの整合性を確認します。

```sql
-- データベース構造の確認
SELECT TABLE_NAME, COLUMN_NAME, DATA_TYPE 
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_SCHEMA = 'Ukeharai' 
ORDER BY TABLE_NAME, ORDINAL_POSITION;

-- 取引先マスタの確認
SELECT * FROM Ukeharai.M_TORI;

-- 請求マスタの確認
SELECT * FROM Ukeharai.T_SEIKYU;

-- 請求明細の確認
SELECT * FROM Ukeharai.T_SEIKYUM;
```

### 2. 計算ロジックの検証
以下のSQLクエリを実行し、金額計算ロジックの整合性を確認します。

```sql
-- 請求明細の金額が数量×単価と一致するか確認
SELECT 
    TORI_CD, SEIKYU_YYYYMM, SEIKYU_TYPE, SEIKYU_NO, KUBUN,
    SURYO, TANKA, KINGAKU,
    CASE 
        WHEN SURYO * TANKA = KINGAKU THEN 'OK'
        ELSE 'NG'
    END AS CHECK_RESULT
FROM Ukeharai.T_SEIKYUM;

-- 端数処理区分ごとの計算結果確認
SELECT 
    t.TORI_CD, t.TORI_NAME, t.HASU_KBN,
    s.SURYO, s.TANKA, s.KINGAKU,
    CASE 
        WHEN t.HASU_KBN = '1' THEN ROUND(s.SURYO * s.TANKA, 0) -- 四捨五入
        WHEN t.HASU_KBN = '2' THEN FLOOR(s.SURYO * s.TANKA) -- 切り捨て
        WHEN t.HASU_KBN = '3' THEN CEILING(s.SURYO * s.TANKA) -- 切り上げ
        ELSE s.SURYO * s.TANKA
    END AS EXPECTED_KINGAKU,
    CASE 
        WHEN s.KINGAKU = CASE 
                            WHEN t.HASU_KBN = '1' THEN ROUND(s.SURYO * s.TANKA, 0)
                            WHEN t.HASU_KBN = '2' THEN FLOOR(s.SURYO * s.TANKA)
                            WHEN t.HASU_KBN = '3' THEN CEILING(s.SURYO * s.TANKA)
                            ELSE s.SURYO * s.TANKA
                          END THEN 'OK'
        ELSE 'NG'
    END AS CHECK_RESULT
FROM Ukeharai.T_SEIKYUM s
JOIN Ukeharai.M_TORI t ON s.TORI_CD = t.TORI_CD;
```

### 3. コード検証
以下のコードポイントを検証し、機能の整合性を確認します。

- RegisterSeikyuMasterForm.vb: UcDgv_CellEndEdit メソッド
  - 数量と単価の入力時に金額が自動計算されるか
  - 未入力フィールドの背景色が変更されるか
  - 金額フィールドが読み取り専用になっているか

- OutputSeikyuReportS.rdlc:
  - 数量と単位が分離されているか
  - 数量と単位の間に線が表示されるか
  - 数量は右寄せ、単位は左寄せで表示されるか

### 4. 影響範囲の検証
以下の機能が正常に動作するか確認します。

- 請求マスタ登録以外の登録機能
- 請求書出力以外の帳票出力機能
- データ作成機能
- バッチ処理機能

## テスト結果記録

| テスト項目 | 結果（OK/NG） | 備考 |
|------------|--------------|------|
| 1. データベース整合性テスト |  |  |
| 2. 計算ロジックの検証 |  |  |
| 3. コード検証 |  |  |
| 4. 影響範囲の検証 |  |  |

## 注意事項

- テスト実行前にデータベースのバックアップを取ることを推奨
- テストデータは本番環境に影響を与えないよう注意
- 問題が発生した場合は、エラーメッセージと再現手順を記録
