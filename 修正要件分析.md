# 生産受払システム機能追加 - 修正要件分析

## 1. 修正要件の概要

### 背景・目的
- 熊本生産G発送運賃請求の入力漏れによる会計処理ミスの再発防止対応
- 2025年3月に発生した請求内容入力漏れの会計処理ミスを防止するための機能改善

### 発生要因
1. 担当者による請求金額入力漏れ
2. 請求マスタにおいて数量×単価入力後の自動計算機能がない（発生真因）

### 具体的な機能追加要件
1. **自動計算機能**: 単価、数量入力後、金額が自動計算される機能を追加
2. **入力促進機能**: 単価、数量いずれか未入力の場合、入力を促す背景反転色付け
3. **手入力防止**: 金額は手入力ができないようグレーアウト化
4. **単位項目追加**: 請求書記載の数量の単位について、「単位」単独の項目を追加
5. **必須項目化**: 追加項目の単位は入力必須項目とし、未入力の場合背景色付けエラー表示

### 請求書の修正
- 請求書フォーマットの変更：金額と単位の間に線を入れる
- 現在の請求書フォーマットから修正後のフォーマットへの変更
- 視覚的な区分けを明確にするためのデザイン変更

## 2. 現在の実装状況

### データモデル
- T_SEIKYUMテーブルには以下のフィールドが含まれています：
  - TORI_CD: 取引先コード
  - SEIKYU_YYYYMM: 請求年月
  - SEIKYU_SQNO: 請求連番
  - SAKU_KBN: 作業区分
  - UCHIWAKE: 内訳
  - TEKIYO: 摘要
  - SURYO: 数量
  - TANI: 単位
  - TANKA: 単価
  - KINGAKU: 金額
  - KAZEI_KBN: 課税区分
  - MEISAI_UMU: 明細有無
  - SAKI_CD: 納入先コード

### 請求マスター登録フォーム
- `RegisterSeikyuMasterForm.vb`が請求マスター登録を担当
- `UcDgv_CellEndEdit`メソッドがセル編集完了時の検証処理を担当
- 現在は`SAKI_CD`と`KAZEI_KBN`フィールドの検証のみ実装
- 自動計算機能は実装されていない

### 請求書レポート
- `OutputSeikyuReportS.rdlc`が請求書レポートテンプレート
- 数量と単位が連結表示 `Format(Fields!SURYO.Value,"#,###") & Fields!TANI.Value`
- 金額は`Format(Fields!KINGAKU.Value,"#,###")`でフォーマット

## 3. 修正が必要なコード箇所

### 自動計算機能の実装
1. **RegisterSeikyuMasterForm.vb**:
   - `UcDgv_CellEndEdit`メソッド（1581行目）に自動計算ロジックを追加
   - SURYO（数量）とTANKA（単価）の変更時にKINGAKU（金額）を自動計算
   - 計算ロジックは請求タイプ（SEIKYU_TYPE）に応じて異なる処理が必要
   - 請求タイプ1: KINGAKU = KOSU * TESU
   - 請求タイプ2: KINGAKU = KOSU * TANKA / 100.0

2. **CustomDataGridView.vb**:
   - `CustomDataGridView_CellEndEdit`メソッド（394行目）は現在型変換のみ実装
   - 自動計算のためのイベント処理を追加する必要あり

### 入力促進機能と必須項目化
1. **RegisterSeikyuMasterForm.vb**:
   - `UcDgv_CellEndEdit`メソッドに入力検証ロジックを追加
   - SURYO、TANKA、TANIフィールドの入力状態を検証
   - 未入力の場合は背景色を変更（エラー表示）

### 手入力防止（金額のグレーアウト）
1. **RegisterSeikyuMasterForm.vb**:
   - `changeGridview`メソッドでKINGAKUフィールドを読み取り専用に設定
   - `AddRow_Button_Click`メソッド（1837行目）で新規行追加時にKINGAKUを読み取り専用に設定

### 請求書フォーマットの修正
1. **OutputSeikyuReportS.rdlc**:
   - 現在の実装: `Format(Fields!SURYO.Value,"#,###") & Fields!TANI.Value`（542行目）
   - 修正: 数量と単位の間に線を追加するためのRDLCテンプレート変更

## 4. 実装方針

### 自動計算機能
```vb
' UcDgv_CellEndEdit メソッドに追加
If "SURYO".Equals(dataGridViewColumn.Name) OrElse "TANKA".Equals(dataGridViewColumn.Name) Then
    ' 数量または単価が変更された場合
    Dim suryo As Decimal = 0
    Dim tanka As Decimal = 0
    
    ' 数量の取得
    If Not IsNothing(dataGridViewRow.Cells("SURYO").Value) AndAlso Not String.IsNullOrEmpty(Conversions.ToString(dataGridViewRow.Cells("SURYO").Value)) Then
        Decimal.TryParse(Conversions.ToString(dataGridViewRow.Cells("SURYO").Value), suryo)
    End If
    
    ' 単価の取得
    If Not IsNothing(dataGridViewRow.Cells("TANKA").Value) AndAlso Not String.IsNullOrEmpty(Conversions.ToString(dataGridViewRow.Cells("TANKA").Value)) Then
        Decimal.TryParse(Conversions.ToString(dataGridViewRow.Cells("TANKA").Value), tanka)
    End If
    
    ' 金額の自動計算
    If suryo > 0 AndAlso tanka > 0 Then
        ' 取引先情報から請求タイプを取得
        Dim dictionary As Dictionary(Of String, Object) = Me.getMtori(Me.ComboTori1.Text)
        Dim seikyu_type As String = Conversions.ToString(dictionary("SEIKYU_TYPE"))
        Dim kingaku As Decimal = 0
        
        ' 請求タイプに応じた計算
        If "1".Equals(seikyu_type) Then
            kingaku = suryo * tanka
        ElseIf "2".Equals(seikyu_type) Then
            kingaku = suryo * tanka / 100.0
        End If
        
        ' 端数処理
        kingaku = Common.hasu(kingaku, Conversions.ToInteger(dictionary("HASU_KBN")), Conversions.ToInteger(dictionary("RITU")))
        
        ' 金額を設定
        dataGridViewRow.Cells("KINGAKU").Value = kingaku
    End If
    
    ' 入力検証（数量、単価、単位）
    ValidateInputFields(dataGridViewRow)
End If
```

### 入力検証機能
```vb
' 入力検証メソッド
Private Sub ValidateInputFields(dataGridViewRow As DataGridViewRow)
    ' 数量の検証
    If IsNothing(dataGridViewRow.Cells("SURYO").Value) OrElse String.IsNullOrEmpty(Conversions.ToString(dataGridViewRow.Cells("SURYO").Value)) Then
        dataGridViewRow.Cells("SURYO").Style.BackColor = Color.LightPink
    Else
        dataGridViewRow.Cells("SURYO").Style.BackColor = Color.White
    End If
    
    ' 単価の検証
    If IsNothing(dataGridViewRow.Cells("TANKA").Value) OrElse String.IsNullOrEmpty(Conversions.ToString(dataGridViewRow.Cells("TANKA").Value)) Then
        dataGridViewRow.Cells("TANKA").Style.BackColor = Color.LightPink
    Else
        dataGridViewRow.Cells("TANKA").Style.BackColor = Color.White
    End If
    
    ' 単位の検証（必須項目）
    If IsNothing(dataGridViewRow.Cells("TANI").Value) OrElse String.IsNullOrEmpty(Conversions.ToString(dataGridViewRow.Cells("TANI").Value)) Then
        dataGridViewRow.Cells("TANI").Style.BackColor = Color.LightPink
        dataGridViewRow.Cells("TANI").ErrorText = "単位は必須項目です"
    Else
        dataGridViewRow.Cells("TANI").Style.BackColor = Color.White
        dataGridViewRow.Cells("TANI").ErrorText = Nothing
    End If
End Sub
```

### 金額フィールドの読み取り専用設定
```vb
' changeGridview メソッドに追加
Private Sub changeGridview()
    ' 既存のコード...
    
    ' KINGAKUフィールドを読み取り専用に設定
    For Each row As DataGridViewRow In Me.UcDgv.CustDgv.Rows
        If row.Index < Me.UcDgv.CustDgv.Rows.Count - 1 Then
            row.Cells("KINGAKU").ReadOnly = True
            row.Cells("KINGAKU").Style.BackColor = Me._bkcolor_readonly
        End If
    Next
End Sub
```

### 請求書レポートの修正
```xml
<!-- OutputSeikyuReportS.rdlc の修正 -->
<TextRun>
  <Value>=Format(Fields!SURYO.Value,"#,###") &amp; " | " &amp; Fields!TANI.Value</Value>
  <Style>
    <FontFamily>ＭＳ ゴシック</FontFamily>
    <Color>=IIf(Fields!SURYO.Value &lt; 0,"Red","Black")</Color>
  </Style>
</TextRun>
```

## 5. 実装スケジュール

1. **準備フェーズ（1日）**
   - 詳細設計書の作成
   - テスト計画の策定

2. **開発フェーズ（3日）**
   - 自動計算機能の実装
   - 入力検証機能の実装
   - 金額フィールドの読み取り専用設定
   - 請求書レポートの修正

3. **テストフェーズ（2日）**
   - 単体テスト
   - 結合テスト
   - ユーザー受け入れテスト

4. **リリースフェーズ（1日）**
   - 本番環境への展開
   - ユーザーマニュアルの更新

## 6. リスク評価

1. **既存データへの影響**
   - 既存の請求データが新しい計算ロジックと一致しない可能性
   - 対策: 移行前のデータ検証と必要に応じた修正

2. **ユーザートレーニング**
   - 新機能の使用方法についてユーザーへの説明が必要
   - 対策: 簡易マニュアルの作成と操作説明会の実施

3. **テスト不足**
   - 様々なケースでの動作確認が不足する可能性
   - 対策: 包括的なテストケースの作成と実施

## 7. まとめ

本修正により、請求マスターにおける数量×単価の自動計算機能を実装し、入力漏れによる会計処理ミスを防止します。また、請求書フォーマットの改善により、数量と単位の視認性を向上させます。これらの改善により、業務効率と正確性の向上が期待されます。
