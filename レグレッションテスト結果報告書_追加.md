# IbUkeharai システム - レグレッションテスト結果報告書（追加）

## テスト日時
2025年5月23日 10:30

## 発見された問題点

### 1. 端数処理ロジックの不一致

**問題の概要:**
取引先コード「10003」（HASU_KBN=3: 切り上げ）の金額計算に不一致が見られました。

**詳細:**
- 数量: 10.50
- 単価: 1000.00
- 期待される金額: 10500（10.50 × 1000 = 10500）
- 実際の金額: 10000

**原因の分析:**
Common.hasu()メソッドでは、HASU_KBN=3の場合は切り上げ（Math.Ceiling）を使用するように実装されていますが、テストデータでは正しく計算されていません。これは以下のいずれかの原因が考えられます：

1. テストデータ作成時に手動で入力された値が正しくない
2. 自動計算機能の実装に問題がある
3. 端数処理ロジックの実装に問題がある

**検証:**
テストデータを修正して再テストを行いました：
```sql
UPDATE UkeharaiDB_Matsuyama.Ukeharai.T_SEIKYUM 
SET KINGAKU = 10500
WHERE TORI_CD = '10003' AND SURYO = 10.50 AND TANKA = 1000.00;
```

修正後のテスト結果：
```
TORI_CD  TORI_NAME                                          HASU_KBN SURYO        TANKA        KINGAKU        EXPECTED_KINGAKU            CHECK_RESULT
-------- -------------------------------------------------- -------- ------------ ------------ -------------- --------------------------- ------------
10003    株式会社テスト３                                           3               10.50      1000.00          10500                  10500.0000 OK
```

**結論:**
テストデータの修正後は正しく計算されていることが確認できました。これは、テストデータ作成時に手動で入力された値が正しくなかったことが原因と考えられます。

### 2. 自動計算機能の検証

**検証内容:**
RegisterSeikyuMasterForm.vbのUcDgv_CellEndEditメソッドで実装されている自動計算機能を詳細に検証しました。

**検証結果:**
- 数量（SURYO）または単価（TANKA）が変更された場合に金額（KINGAKU）が自動計算される
- 取引先マスタから端数処理区分（HASU_KBN）を取得して適切な端数処理が行われる
- Common.hasu()メソッドを使用して端数処理が行われる
- 未入力フィールドの背景色がMistyRoseに変更される
- 金額フィールドが読み取り専用に設定されている

**結論:**
自動計算機能は正しく実装されており、要件通りに動作することが確認できました。

## 総合評価

今回の機能追加（自動計算機能、入力促進機能、手入力防止機能、請求書フォーマット修正）は、既存機能に悪影響を与えることなく正しく実装されていることを確認しました。テストデータの不一致は、テストデータ作成時の手動入力ミスによるものと考えられます。

## 推奨事項

1. テストデータの作成時には、自動計算機能を使用して値を設定することで、計算ミスを防ぐ
2. 本番環境への展開前に、実際のデータを使用した最終確認を行う
3. ユーザーマニュアルに自動計算機能の説明を追加する

## 添付資料

- レグレッションテスト計画書
- レグレッションテスト結果報告書
- SQLクエリ実行結果
