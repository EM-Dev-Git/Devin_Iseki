# 月末処理エラー調査報告書

## 1. 概要

本報告書は、IbUkeharaiシステムの月末処理機能で発生しているエラーについての調査結果をまとめたものです。月末処理は、月次の受払データを集計し、次月のデータ準備を行う重要な機能です。

## 2. 調査対象

以下のコンポーネントを調査対象としました：

- `BatchMonthlyDataForm.vb`：月末処理の主要ロジック
- `ConstantMessage.vb`：エラーメッセージ定義
- `Ukeharai.Update_Month_Data`：月次データ更新用ストアドプロシージャ
- `Ukeharai.Update_Nengetu_Value`：年月値更新用ストアドプロシージャ
- `IbUkeharai.log`：エラーログファイル

## 3. エラーメッセージ

月末処理に関連するエラーメッセージは以下の通りです：

- `MSG_E42001`：「月次処理を中断しました。」
- `MSG_E42002`：「月次更新情報を取得に失敗しました。」
- `MSG_E42003`：「受払実績情報の更新に失敗しました。」
- `MSG_E42004`：「受払実績情報の更新中に異常が発生しました。」
- `MSG_E42005`：「日付テーブルの年月更新に失敗しました。」

## 4. ログ分析

### 4.1 エラーログの内容

デバッグログ（IbUkeharai.log）には以下のエラーが記録されています：

```
2023/03/07 16:02:31 :CurrentDomain_UnhandledException Unhandled Exception!! : オブジェクト同期メソッドは、コードの非同期ブロックから呼び出されました。
2023/03/07 16:02:34 :CurrentDomain_UnhandledException Unhandled Exception!! : オブジェクト同期メソッドは、コードの非同期ブロックから呼び出されました。
2023/03/07 16:28:12 :CurrentDomain_UnhandledException Unhandled Exception!! : オブジェクト同期メソッドは、コードの非同期ブロックから呼び出されました。
2023/03/07 16:28:14 :CurrentDomain_UnhandledException Unhandled Exception!! : オブジェクト同期メソッドは、コードの非同期ブロックから呼び出されました。
2023/03/07 16:34:11 :CurrentDomain_UnhandledException Unhandled Exception!! : オブジェクト同期メソッドは、コードの非同期ブロックから呼び出されました。
2023/03/07 16:34:12 :CurrentDomain_UnhandledException Unhandled Exception!! : オブジェクト同期メソッドは、コードの非同期ブロックから呼び出されました。
```

このエラーメッセージは、非同期コードブロックから同期メソッドが呼び出されたことを示しています。これは、BackgroundWorkerを使用した非同期処理と、UIスレッドで実行される同期メソッド間の競合が原因と考えられます。

## 5. 潜在的なエラー原因

### 5.1 非同期処理の問題（BackgroundWorker）

BatchMonthlyDataForm.vbでは、月末処理を非同期で実行するためにBackgroundWorkerを使用しています：

```vb
Private Function StartExec() As Boolean
    Dim result As Boolean = False
    Me._isCancel = False
    Me._isErrer = False
    Dim dialogResult As DialogResult = DialogResult.None
    Using dlgProcess As New DlgProcess("月次処理", AddressOf Me.UpdateMonthData, 100)
        dialogResult = dlgProcess.ShowDialog(Me)
    End Using
    If Not Me._isErrer Then
        result = True
    End If
    If dialogResult = DialogResult.Cancel Then
        Me._isCancel = True
    End If
    Return result
End Function
```

**潜在的な問題点**：
- BackgroundWorkerの処理中にUIスレッドとの同期が適切に行われていない
- DlgProcessクラスがBackgroundWorkerを使用しているが、同期メソッドを呼び出している可能性がある
- 非同期処理中のキャンセル処理が適切に実装されていない

### 5.2 日付検証の問題（CheckExecDay メソッド）

```vb
Private Function CheckExecDay() As Boolean
    Dim hizukeSql As String = Me.GetHizukeSql()
    Dim dbParam As DataTable = Me.GetDbParam(hizukeSql)
    If dbParam.Rows.Count < 1 Then
        Return False
    End If
    Dim s As String = Conversions.ToString(dbParam.Rows(0)("NENGETSU"))
    Dim execday As DateTime = DateTime.Parse(s)
    If DateAndTime.Now.Month <> execday.AddMonths(1).Month Then
        Return False
    End If
    Me._execday = execday
    Return True
End Function
```

**潜在的な問題点**：
- `T_HIZUKE`テーブルにデータが存在しない場合、処理が失敗します
- 現在の月と`execday.AddMonths(1).Month`が一致しない場合、処理が失敗します
- 月末日に処理を実行すると、翌日が翌月になるため、タイミングによっては条件を満たさなくなる可能性があります
- 日付文字列のパース処理で例外が発生する可能性があります

### 5.3 トランザクション処理の問題（UpdateMonthData メソッド）

```vb
Private Sub UpdateMonthData(sender As Object, e As DoWorkEventArgs)
    Me._viewinfo = New viewInfo()
    Using sqlDataBase As New SqlDataBase(Me._conf.xmlConfData.xDataBase)
        Dim backgroundWorker As BackgroundWorker = CType(sender, BackgroundWorker)
        Dim count As Integer = Me._monthTb.Rows.Count
        Dim num As Integer = 0
        If sqlDataBase.BeginTransaction() Then
            Try
                Dim flag As Boolean = False
                Dim allToriSql As String = Me.GetAllToriSql()
                Dim dbParam As DataTable = Me.GetDbParam(allToriSql)
                If dbParam.Rows.Count < 1 Then
                    flag = True
                Else
                    count = Me._monthTb.Rows.Count
                    backgroundWorker.ReportProgress(num, "月次更新：" + (CDbl(num) / CDbl(count)).ToString("P0"))
                    Try
                        For Each obj As Object In dbParam.Rows
                            Dim dataRow As DataRow = CType(obj, DataRow)
                            Dim filterExpression As String = String.Format("取引先コード = '{0}'", RuntimeHelpers.GetObjectValue(dataRow("TORI_CD")))
                            Dim array As DataRow() = Me._monthTb.[Select](filterExpression)
                            If array.Length >= 1 Then
                                If backgroundWorker.CancellationPending Then
                                    flag = True
                                End If
                                Dim text As String = Conversions.ToString(dataRow("TORI_CD"))
                                Dim buhin_cd As String = Conversions.ToString(array(array.Length - 1)("部品コード"))
                                Dim listParams As List(Of SqlDataBase.SqlParamInfo) = Me.CreateUpdateStoredParam(text, Me._execday)
                                Dim storedProcedureData As String = sqlDataBase.getStoredProcedureData("Ukeharai.Update_Month_Data", listParams, False)
                                If Operators.CompareString(storedProcedureData, String.Empty, False) <> 0 Then
                                    flag = True
                                    OutputLog.WriteLine(String.Format("UPDATE ERRER [{0}] : ExecYMD[{1}]", storedProcedureData, Me._execday))
                                End If
                                num += array.Length
                                backgroundWorker.ReportProgress(num, "月次更新：" + (CDbl(num) / CDbl(count)).ToString("P0"))
                                Me._viewinfo.tori_cd = text
                                Me._viewinfo.buhin_cd = buhin_cd
                                Me._viewinfo.count = num
                            End If
                        Next
                    Finally
                        Dim enumerator As IEnumerator = Nothing
                        If TypeOf enumerator Is IDisposable Then
                            TryCast(enumerator, IDisposable).Dispose()
                        End If
                    End Try
                    If Not flag Then
                        sqlDataBase.CommitTransact()
                    Else
                        Me._isErrer = True
                        sqlDataBase.RollbackTransact()
                    End If
                End If
            Catch ex As Exception
                Me._isErrer = True
                sqlDataBase.RollbackTransact()
                OutputLog.WriteLine(String.Format("月次処理中に異常発生 {0}", ex.ToString()))
                DlgMessageBox.Show("受払実績情報の更新中に異常が発生しました。", "エラー", MessageBoxButtons.OK, MessageBoxIcon.Hand)
            End Try
        End If
    End Using
End Sub
```

**潜在的な問題点**：
- トランザクション開始に失敗した場合のエラーハンドリングがありません
- 取引先マスタ（M_TORI）の取得に失敗した場合、処理が中断されます
- ストアドプロシージャ実行時のエラーハンドリングが不十分です
- バックグラウンドワーカーのキャンセル処理が複雑で、エラーが発生する可能性があります
- **非同期処理中にUIスレッドのメソッド（DlgMessageBox.Show）を呼び出しており、これがログに記録されたエラーの原因と考えられます**

### 5.4 ストアドプロシージャの問題（Ukeharai.Update_Month_Data）

```sql
ALTER PROCEDURE [Ukeharai].[Update_Month_Data]
    @S_ToriCd           NVARCHAR(8),
    @D_ExecYYYYMMDD     Date,
    @ID_User            NVARCHAR(50),
    @D_UpdateTime       DateTime,
    @ID_Func            NVARCHAR(50)
AS
BEGIN
    -- 処理内容
    -- ...
    
    -- レコード削除
    DELETE Ukeharai.T_UKEHARAIJISSEKI
    WHERE EXISTS
        (
            SELECT Buhin.BUHIN_CD
            FROM Ukeharai.M_BUHIN [Buhin]
            WHERE Buhin.BUHIN_CD <> ''
            AND T_UKEHARAIJISSEKI.BUHIN_CD = Buhin.BUHIN_CD
            AND T_UKEHARAIJISSEKI.TORI_CD = @ID_Tori
            AND T_UKEHARAIJISSEKI.UKEHARA_YYYYMM = @D_FromYYYYMMDD
        ) 
    
    -- レコード追加
    INSERT INTO Ukeharai.T_UKEHARAIJISSEKI VALUES
    (@ID_Tori, @ID_Buhin, @D_FromYYYYMMDD, @I_Zaikosu, @I_Ukesu, @I_Harasu, @Inset_User, @Inset_DTM, @Inset_Function, @ID_User, @D_UpdateTime,@ID_Func)
    
    -- ...
END
```

**潜在的な問題点**：
- カーソル処理でのエラーハンドリングが不十分です
- データ型変換（CONVERT）でエラーが発生する可能性があります
- DELETE文の条件が複雑で、意図しないレコードが削除される可能性があります
- INSERT文でのエラーハンドリングがありません
- トランザクション制御がVB.NETコード側に依存しています

### 5.5 年月更新の問題（UpdateNengatuValue メソッド）

```vb
Private Function UpdateNengatuValue() As Boolean
    Dim result As Boolean = False
    Using sqlDataBase As New SqlDataBase(Me._conf.xmlConfData.xDataBase)
        Dim listParams As List(Of SqlDataBase.SqlParamInfo) = Me.CreateUpdateNengatuStoredParam()
        Dim storedProcedureData As String = sqlDataBase.getStoredProcedureData("Ukeharai.Update_Nengetu_Value", listParams, False)
        If Operators.CompareString(storedProcedureData, String.Empty, False) = 0 Then
            result = True
        Else
            OutputLog.WriteLine(String.Format("UPDATE ERRER [{0}] : NengetuYMD[{1}] ", storedProcedureData, Me._execday.ToString("yyyy/MM/dd")))
        End If
    End Using
    Return result
End Function
```

**潜在的な問題点**：
- ストアドプロシージャの実行結果の判定が不十分です
- トランザクション制御がありません
- エラーメッセージのログ出力はされますが、例外処理がありません

### 5.6 ストアドプロシージャの問題（Ukeharai.Update_Nengetu_Value）

```sql
ALTER PROCEDURE [Ukeharai].[Update_Nengetu_Value]
    @D_NengetuYMD       Date,
    @ID_User            NVARCHAR(50),
    @D_UpdateTime       DateTime,
    @ID_Func            NVARCHAR(50)
AS
BEGIN
    -- Insert statements for procedure here
    UPDATE Ukeharai.T_HIZUKE
        SET  NENGETSU           = DATEADD(MONTH, 1, NENGETSU)
            ,UPDATE_USER        = @ID_user
            ,UPDATE_DTM         = @D_UpdateTime
            ,UPDATE_FUNCTION    = @ID_Func

    WHERE   NENGETSU = @D_NengetuYMD

    RETURN @@ROWCOUNT
END
```

**潜在的な問題点**：
- 更新対象のレコードが存在しない場合、0が返されますが、VB.NET側でこの値を適切に処理していない可能性があります
- DATEADD関数で月を加算する際、月末日の処理で問題が発生する可能性があります（例：1/31 + 1ヶ月 = 2/28）
- トランザクション制御がVB.NETコード側に依存しています

### 5.7 パスワード検証の問題

```vb
Private Sub BMD_ExecutButton_Click(sender As Object, e As EventArgs) Handles BMD_ExecutButton.Click
    If Me.PasswordTextBox.Text.Length < 1 Then
        DlgMessageBox.Show("パスワードを入力してください。", "警告", MessageBoxButtons.OK, MessageBoxIcon.Exclamation)
        Return
    End If
    If Not Me.PasswordTextBox.Text.Equals("UH") Then
        DlgMessageBox.Show("パスワードが違います。", "警告", MessageBoxButtons.OK, MessageBoxIcon.Exclamation)
        Return
    End If
    ' 以下、処理続行
End Sub
```

**潜在的な問題点**：
- パスワード「UH」がハードコードされており、セキュリティ上の問題があります
- パスワード検証が単純な文字列比較で行われており、大文字小文字の区別などに注意が必要です

## 6. データ整合性の問題

月末処理では以下のデータ整合性の問題が発生する可能性があります：

1. **T_HIZUKE**テーブルの**NENGETSU**値が不正な場合、月末処理の実行可否判定が誤る
2. **T_UKEHARAIMEISAI**テーブルと**T_UKEHARAIJISSEKI**テーブル間のデータ不整合
3. 月末処理の途中キャンセルによるトランザクション不整合
4. 日付の加算処理による月末日の扱いの問題（2月など）

## 7. 推奨される対策

1. **非同期処理の改善**
   - BackgroundWorkerでのUI操作を避け、Invoke/BeginInvokeを使用する
   - 非同期処理中の例外をキャッチし、適切に処理する
   - 非同期処理の進捗報告とキャンセル処理を改善する

2. **日付検証ロジックの改善**
   - 現在の日付チェックロジックをより堅牢にする
   - 例外処理を追加し、エラーメッセージを詳細化する
   - 月末日の特殊ケースを考慮した処理を追加する

3. **トランザクション処理の強化**
   - トランザクション開始失敗時のエラーハンドリングを追加
   - 処理の各ステップでの状態確認と適切なロールバック処理
   - 非同期処理中のトランザクション管理を改善する

4. **ストアドプロシージャの改善**
   - エラーハンドリングの強化
   - 戻り値の適切な処理
   - データ型変換エラーの防止
   - トランザクション制御の改善

5. **セキュリティの強化**
   - ハードコードされたパスワードの排除
   - 適切な認証メカニズムの導入

6. **テストケースの拡充**
   - 月末日での処理テスト
   - データ不整合状態での処理テスト
   - エラー発生時の回復処理テスト
   - 非同期処理のテスト

## 8. 結論

月末処理のエラーは、主に非同期処理における同期メソッドの呼び出し、日付検証ロジック、トランザクション処理、およびストアドプロシージャの実行に関連する問題が原因と考えられます。特に、BackgroundWorkerを使用した非同期処理中にUIスレッドのメソッドを直接呼び出していることが、ログに記録されたエラー「オブジェクト同期メソッドは、コードの非同期ブロックから呼び出されました」の主な原因と考えられます。

上記の推奨対策を実施することで、月末処理の安定性と信頼性を向上させることができると考えられます。特に、非同期処理の改善とトランザクション管理の強化が重要です。
