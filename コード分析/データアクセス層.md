# IbUkeharai システム - データアクセス層
   
## 1. SqlDataBase クラス
データベース接続とトランザクション管理を担当。以下の機能を提供：
   
### 1.1 データベース接続
接続情報はConfig.xmlに格納され、XmlConfigControlクラスで読み込まれる：
```xml
<xDataBase>
  <DBName>UkeharaiDB_Matsuyama</DBName>
  <ServerName>localhost</ServerName>
  <UserId>sa</UserId>
  <PassWord>StrongPassword123!</PassWord>
</xDataBase>
```

主要なメソッド：
- Open(): 接続を開く
- Close(): 接続を閉じる
- IsOpen(): 接続が開いているかどうかを確認
   
### 1.2 トランザクション管理
- BeginTransaction(): トランザクション開始
- CommitTransact(): トランザクションのコミット
- RollbackTransact(): トランザクションのロールバック

```vb
' トランザクション開始
Public Function BeginTransaction() As Boolean
    Try
        Open()
        _transaction = _connection.BeginTransaction()
        Return True
    Catch ex As Exception
        Return False
    End Try
End Function

' トランザクションコミット
Public Function CommitTransact() As Boolean
    Try
        _transaction.Commit()
        Return True
    Catch ex As Exception
        Return False
    Finally
        _transaction = Nothing
    End Try
End Function

' トランザクションロールバック
Public Function RollbackTransact() As Boolean
    Try
        _transaction.Rollback()
        Return True
    Catch ex As Exception
        Return False
    Finally
        _transaction = Nothing
    End Try
End Function
```
   
### 1.3 データ操作
- getSQLData(): SQL文の実行と結果取得
- execSql(): SQL文の実行（更新系）
- getStoredProcedureData(): ストアドプロシージャの実行

```vb
' SQL実行（SELECT）
Public Function getSQLData(sql As String) As Boolean
    Try
        Open()
        
        Dim command As New SqlCommand(sql, _connection)
        If _transaction IsNot Nothing Then
            command.Transaction = _transaction
        End If
        
        Dim reader As SqlDataReader = command.ExecuteReader()
        DbData.SetData(reader)
        
        Return True
    Catch ex As Exception
        Return False
    Finally
        If _transaction Is Nothing Then
            Close()
        End If
    End Try
End Function

' SQL実行（INSERT/UPDATE/DELETE）
Public Function execSql(sql As String) As Boolean
    Try
        Open()
        
        Dim command As New SqlCommand(sql, _connection)
        If _transaction IsNot Nothing Then
            command.Transaction = _transaction
        End If
        
        command.ExecuteNonQuery()
        
        Return True
    Catch ex As Exception
        Return False
    Finally
        If _transaction Is Nothing Then
            Close()
        End If
    End Try
End Function
```

## 2. データアクセスパターン

### 2.1 マスタデータ取得
マスタテーブルからデータを取得するパターン。

```vb
' 取引先マスタの取得
Using sqlDataBase As New SqlDataBase(Me._conf.xmlConfData.xDataBase)
    Dim sql As String = "SELECT TORI_CD, TORI_NAME, SEIKYU_TYPE, RITU, HASU_KBN FROM Ukeharai.M_TORI"
    If sqlDataBase.getSQLData(sql) Then
        ' データの処理
        For Each row As Dictionary(Of String, Object) In sqlDataBase.DbData.DataList
            Dim toriCd As String = Conversions.ToString(row("TORI_CD"))
            Dim toriName As String = Conversions.ToString(row("TORI_NAME"))
            Dim hasuKbn As String = Conversions.ToString(row("HASU_KBN"))
            ' データの利用
        Next
    End If
End Using
```

### 2.2 トランザクションデータ更新
トランザクション制御を使用したデータ更新パターン。

```vb
' データ更新
Using sqlDataBase As New SqlDataBase(Me._conf.xmlConfData.xDataBase)
    ' トランザクション開始
    If sqlDataBase.BeginTransaction() Then
        Try
            ' データ更新
            Dim sql As String = "INSERT INTO Ukeharai.T_UKEHARAIMEISAI (TORI_CD, BUHIN_CD, UKEHARA_YYYYMMDD, DEN_NO, UKEHARAI_KBN, KOSU, SAKI_CD, KINGAKU, TESU) VALUES ('10001', 'P001', '20250520', '0001', '1', 10, '001', 10000, 1)"
            If Not sqlDataBase.execSql(sql) Then
                Throw New Exception("データ更新に失敗しました。")
            End If
            
            ' トランザクションコミット
            If Not sqlDataBase.CommitTransact() Then
                Throw New Exception("トランザクションのコミットに失敗しました。")
            End If
            
            Return True
        Catch ex As Exception
            ' トランザクションロールバック
            sqlDataBase.RollbackTransact()
            Return False
        End Try
    End If
End Using
```

### 2.3 ストアドプロシージャ実行
ストアドプロシージャを実行するパターン。

```vb
' ストアドプロシージャの実行
Using sqlDataBase As New SqlDataBase(Me._conf.xmlConfData.xDataBase)
    Dim parameters As New Dictionary(Of String, Object)
    parameters.Add("@TORI_CD", "10001")
    parameters.Add("@BUHIN_CD", "P001")
    parameters.Add("@UKEHARA_YYYYMM", "202505")
    
    If sqlDataBase.getStoredProcedureData("Ukeharai.Update_Month_Data", parameters) Then
        ' 結果の処理
        For Each row As Dictionary(Of String, Object) In sqlDataBase.DbData.DataList
            ' データの利用
        Next
    End If
End Using
```
