# IbUkeharai システム - データフロー
   
## 1. 登録機能のデータフロー
   
### 1.1 請求マスタ登録の例
   
1. **UI入力**:
   - ユーザーが請求マスタ登録フォーム（RegisterSeikyuMasterForm）でデータを入力
   - 数量（SURYO）と単価（TANKA）を入力すると、金額（KINGAKU）が自動計算される
   - 未入力フィールドの背景色がMistyRoseに変更される

2. **データ検証**:
   - 必須項目の入力チェック（未入力の場合は背景色が変更される）
   - コード値の存在チェック（存在しない場合はエラーメッセージを表示）
   - 数値の妥当性チェック

3. **データベース操作**:
   - 「実行」ボタンクリック時にRBM_ExecutButton_Clickイベントハンドラが起動
   - UcDgv.UpdateGridView()メソッドがデータベース更新処理を実行
   - トランザクション開始（BeginTransaction）
   - INSERT/UPDATE/DELETE SQLの実行
   - トランザクションコミット（CommitTransact）

```mermaid
sequenceDiagram
    actor User
    participant UI as RegisterSeikyuMasterForm
    participant BL as ControlDataGridView
    participant DA as SqlDataBase
    participant DB as Database
    
    User->>UI: 入力（数量、単価）
    UI->>UI: 自動計算（金額）
    UI->>UI: 入力検証
    User->>UI: 実行ボタンクリック
    UI->>BL: UpdateGridView()
    BL->>DA: BeginTransaction()
    DA->>DB: BEGIN TRANSACTION
    BL->>DA: execSql(INSERT/UPDATE/DELETE)
    DA->>DB: SQL実行
    BL->>DA: CommitTransact()
    DA->>DB: COMMIT
    UI->>User: 処理結果表示
```
   
## 2. 帳票出力のデータフロー
   
### 2.1 請求書出力の例
   
1. **条件指定**:
   - ユーザーが請求書出力フォーム（OutPutSeikyuForm）で出力条件を指定
   - 年月と取引先を選択

2. **データ取得**:
   - 「実行」ボタンクリック時にOPS_ExecutButton_Clickイベントハンドラが起動
   - データベースから請求データを取得
   - 請求ヘッダ（T_SEIKYU）と請求明細（T_SEIKYUM）を結合して取得

3. **レポート生成**:
   - OutPutSeikyuFormReportViewSeikyuフォームでレポートを表示
   - Microsoft Reporting Servicesを使用してRDLCテンプレートにデータをバインド
   - レポート出力（プレビューまたは印刷）

```mermaid
sequenceDiagram
    actor User
    participant UI1 as OutPutSeikyuForm
    participant UI2 as OutPutSeikyuFormReportViewSeikyu
    participant DA as SqlDataBase
    participant DB as Database
    participant RP as ReportViewer
    
    User->>UI1: 条件指定（年月、取引先）
    User->>UI1: 実行ボタンクリック
    UI1->>DA: getSQLData(SQL)
    DA->>DB: SELECT実行
    DB->>DA: 結果セット
    DA->>UI1: データ
    UI1->>UI2: レポート表示
    UI2->>RP: データバインド
    RP->>UI2: レポート生成
    UI2->>User: レポート表示
```
   
## 3. バッチ処理のデータフロー
   
### 3.1 受入データ書き込みの例
   
1. **データ読込**:
   - UkeHaraiDataWritクラスがファイルからデータを読み込み
   - データの形式を検証
   - CSVファイルから受入データを読み込み

2. **データ処理**:
   - トランザクション開始（BeginTransaction）
   - データの変換と検証
   - マスタデータとの整合性チェック
   - 取引先マスタ（M_TORI）で取引先コード検証
   - 部品マスタ（M_BUHIN）で部品コード検証

3. **データベース更新**:
   - T_UKEHARAIMEISAIテーブルへのINSERT
   - T_UKEHARAIJISSEKIテーブルの更新
   - トランザクションコミット（CommitTransact）
   - 処理結果をOK/ERRファイルに出力
   - 元ファイルをバックアップ

```mermaid
sequenceDiagram
    actor User
    participant UI as BatchUkeireDataWritForm
    participant BL as UkeHaraiDataWrit
    participant DA as SqlDataBase
    participant DB as Database
    participant FS as FileSystem
    
    User->>UI: 実行ボタンクリック
    UI->>BL: UkeDataWrite()
    BL->>FS: ファイル読込
    BL->>DA: BeginTransaction()
    DA->>DB: BEGIN TRANSACTION
    BL->>DA: getSQLData(マスタ検証)
    DA->>DB: SELECT実行
    DB->>DA: 結果セット
    BL->>DA: execSql(INSERT)
    DA->>DB: INSERT実行
    BL->>DA: CommitTransact()
    DA->>DB: COMMIT
    BL->>FS: 結果ファイル出力
    BL->>FS: 元ファイルバックアップ
    BL->>UI: 処理結果
    UI->>User: 処理結果表示
```

## 4. 自動計算機能のデータフロー

1. **入力イベント**:
   - ユーザーが数量（SURYO）または単価（TANKA）を入力
   - UcDgv_CellEndEditイベントハンドラが起動

2. **入力検証**:
   - 数量と単価の入力値を検証
   - 未入力の場合は背景色をMistyRoseに変更

3. **端数処理区分取得**:
   - 取引先マスタ（M_TORI）から端数処理区分（HASU_KBN）を取得

4. **金額計算**:
   - 数量 × 単価 = 金額
   - Common.hasuメソッドで端数処理
   - 金額（KINGAKU）フィールドに設定

```mermaid
sequenceDiagram
    actor User
    participant UI as RegisterSeikyuMasterForm
    participant DA as SqlDataBase
    participant DB as Database
    participant BL as Common
    
    User->>UI: 数量または単価を入力
    UI->>UI: UcDgv_CellEndEdit起動
    UI->>UI: 入力値検証
    UI->>DA: getSQLData(HASU_KBN取得)
    DA->>DB: SELECT実行
    DB->>DA: 結果セット
    DA->>UI: HASU_KBN
    UI->>BL: hasu(金額, HASU_KBN)
    BL->>UI: 端数処理後の金額
    UI->>UI: 金額フィールドに設定
    UI->>User: 金額表示
```
