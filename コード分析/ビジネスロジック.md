# IbUkeharai システム - ビジネスロジック
   
## 1. Common クラス
共通ユーティリティ機能を提供。主要な機能：
   
### 1.1 端数処理（hasu メソッド）
金額計算時の端数処理方法：
- HASU_KBN=1: 四捨五入（Math.Round + MidpointRounding.AwayFromZero）
- HASU_KBN=2: 切り捨て（Math.Floor）
- HASU_KBN=3: 切り上げ（Math.Ceiling）

```vb
' 端数処理
Public Shared Function hasu(value As Decimal, hasuKbn As String) As Decimal
    Select Case hasuKbn
        Case "1" ' 四捨五入
            Return Math.Round(value, 0, MidpointRounding.AwayFromZero)
        Case "2" ' 切り捨て
            Return Math.Floor(value)
        Case "3" ' 切り上げ
            Return Math.Ceiling(value)
        Case Else
            Return value
    End Select
End Function
```
   
## 2. 自動計算機能
RegisterSeikyuMasterFormのUcDgv_CellEndEditメソッドで実装。処理フロー：
1. 数量（SURYO）または単価（TANKA）のセル編集完了時にイベント発火
2. 入力値の検証（空チェック）
3. 取引先マスタから端数処理区分（HASU_KBN）取得
4. 金額計算（SURYO × TANKA）
5. 端数処理（Common.hasuメソッド使用）
6. 金額（KINGAKU）フィールドへの設定（読み取り専用）

```vb
' 自動計算機能
Private Sub UcDgv_CellEndEdit(sender As Object, e As DataGridViewCellEventArgs) Handles UcDgv.CellEndEdit
    ' 数量または単価が変更された場合
    If "SURYO".Equals(dataGridViewColumn.Name) OrElse "TANKA".Equals(dataGridViewColumn.Name) Then
        ' 数量と単価の値を取得
        Dim suryo As Decimal = 0
        Dim tanka As Decimal = 0
        Dim hasValue As Boolean = True
        
        ' 数量の検証
        If IsNothing(dataGridViewRow.Cells("SURYO").Value) OrElse 
           String.IsNullOrEmpty(Conversions.ToString(dataGridViewRow.Cells("SURYO").Value)) Then
            dataGridViewRow.Cells("SURYO").Style.BackColor = Color.MistyRose
            hasValue = False
        Else
            Decimal.TryParse(Conversions.ToString(dataGridViewRow.Cells("SURYO").Value), suryo)
            dataGridViewRow.Cells("SURYO").Style.BackColor = Me._bkcolor_normal
        End If
        
        ' 単価の検証
        If IsNothing(dataGridViewRow.Cells("TANKA").Value) OrElse 
           String.IsNullOrEmpty(Conversions.ToString(dataGridViewRow.Cells("TANKA").Value)) Then
            dataGridViewRow.Cells("TANKA").Style.BackColor = Color.MistyRose
            hasValue = False
        Else
            Decimal.TryParse(Conversions.ToString(dataGridViewRow.Cells("TANKA").Value), tanka)
            dataGridViewRow.Cells("TANKA").Style.BackColor = Me._bkcolor_normal
        End If
        
        ' 数量と単価の両方が入力されている場合、金額を計算
        If hasValue Then
            ' 取引先情報から端数処理方法を取得
            Dim hasuKbn As String = "1" ' デフォルト値
            Using sqlDataBase As New SqlDataBase(Me._conf.xmlConfData.xDataBase)
                Dim sql As String = "SELECT HASU_KBN FROM Ukeharai.M_TORI WHERE TORI_CD = '" & Me.ComboTori1.Text.Trim() & "'"
                If sqlDataBase.execSql(sql) Then
                    If sqlDataBase.DbData.DataList.Count > 0 Then
                        hasuKbn = Conversions.ToString(sqlDataBase.DbData.DataList(0)("HASU_KBN"))
                    End If
                End If
            End Using
            
            ' 金額を計算（数量 × 単価）
            Dim kingaku As Decimal = suryo * tanka
            
            ' 端数処理（取引先マスタのHASU_KBNに基づく）
            kingaku = Common.hasu(kingaku, hasuKbn)
            
            ' 金額を設定
            dataGridViewRow.Cells("KINGAKU").Value = kingaku
        End If
    End If
End Sub
```
   
## 3. 入力促進機能
未入力フィールドの背景色変更機能：
1. IsNothingまたはString.IsNullOrEmptyで未入力検出
2. 未入力フィールドの背景色をColor.MistyRoseに変更
3. 入力があれば背景色を通常色（_bkcolor_normal）に戻す

## 4. 手入力防止機能
金額（KINGAKU）フィールドを読み取り専用に設定し、手入力を防止する機能：

```vb
' 金額フィールドを読み取り専用に設定
Private Sub InitializeDataGridView()
    ' 金額列を読み取り専用に設定
    Dim kingakuColumn As DataGridViewColumn = Me.UcDgv.CustDgv.Columns("KINGAKU")
    kingakuColumn.ReadOnly = True
    kingakuColumn.DefaultCellStyle.BackColor = Me._bkcolor_readonly
End Sub
```
   
## 5. データベース更新機能
ControlDataGridViewのUpdateGridViewメソッドでデータベース更新を実行：
1. 変更されたデータの検出
2. 追加/変更/削除の区分に応じたSQL文の生成
3. トランザクション制御によるデータベース更新

```vb
' データベース更新
Public Function UpdateGridView() As Boolean
    ' トランザクション開始
    If Not _sqlDataBase.BeginTransaction() Then
        Return False
    End If
    
    Try
        ' 変更データの検出
        For Each row As DataGridViewRow In _dataGridView.Rows
            If row.Tag IsNot Nothing Then
                Dim rowState As String = Conversions.ToString(row.Tag)
                
                ' SQL文の生成
                Dim sql As String = ""
                
                Select Case rowState
                    Case "A" ' 追加
                        sql = GenerateInsertSQL(row)
                    Case "U" ' 更新
                        sql = GenerateUpdateSQL(row)
                    Case "D" ' 削除
                        sql = GenerateDeleteSQL(row)
                End Select
                
                ' SQL実行
                If Not String.IsNullOrEmpty(sql) Then
                    If Not _sqlDataBase.execSql(sql) Then
                        Throw New Exception("SQL実行エラー: " & sql)
                    End If
                End If
            End If
        Next
        
        ' トランザクションコミット
        If Not _sqlDataBase.CommitTransact() Then
            Throw New Exception("トランザクションコミットエラー")
        End If
        
        Return True
    Catch ex As Exception
        ' トランザクションロールバック
        _sqlDataBase.RollbackTransact()
        Return False
    End Try
End Function
```

## 6. バッチ処理機能

### 6.1 受入データ処理
UkeHaraiDataWritクラスのUkeDataWriteメソッドで実装。処理フロー：
1. CSVファイルから受入データを読み込み
2. 取引先マスタ（M_TORI）で取引先コード検証
3. 部品マスタ（M_BUHIN）で部品コード検証
4. 検証済みデータをT_UKEHARAIMEISAIテーブルに登録
5. 処理結果をOK/ERRファイルに出力
6. 元ファイルをバックアップ

### 6.2 払出データ処理
UkeHaraiDataWritクラスのHaraiDataWriteメソッドで実装。処理フロー：
1. 固定長テキストファイルから払出データを読み込み（SN41A00クラスで解析）
2. 取引先マスタ（M_TORI）で取引先コード検証
3. 部品マスタ（M_BUHIN）で部品コード検証
4. 単価マスタ（M_TANKA）で単価情報取得
5. 検証済みデータをT_UKEHARAIMEISAIテーブルに登録（UKEHARAI_KBN="2"）
6. 処理結果をOK/ERRファイルに出力
7. 元ファイルをバックアップ
